<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Submission - Review 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #181f2e 0%, #232c41 100%);
      color: #f4f6fb;
      font-family: Arial, sans-serif;
    }
    .main-wrapper {
      max-width: 880px;
      margin: 40px auto;
      background: rgba(24, 31, 46, 0.93);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 40px rgba(35,44,65,0.15);
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .profile-icon {
      background: url("icon.jpg");
      background-size: cover;
      width: 70px;
      height: 70px;
      border-radius: 16px;
      border: 3px solid #2f3655;
    }
    nav.nav-links {
      display: flex;
      gap: 14px;
      margin-bottom: 32px;
    }
    .nav-link {
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      color: #96b5ff;
      font-weight: 500;
    }
    .nav-link:hover {
      color: #fff;
      background: linear-gradient(90deg, #4f46e5 70%, #be9e6f 100%);
    }
    .nav-link.active {
      color: white;
      background: linear-gradient(90deg, #be9e6f 70%, #4f46e5 100%);
    }
    h1 {
      font-size: 2.2rem;
      color: #fff;
      font-weight: 800;
    }
    form {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .form-group label {
      font-size: 1rem;
      color: #b4bad9;
    }
    .form-group input,
    .form-group textarea {
      font-size: 1rem;
      padding: 9px 12px;
      border: none;
      border-radius: 7px;
      background: #232c41;
      color: #eaf1fa;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #be9e6f;
    }
    .upload-section {
      grid-column: 1 / 3;
      margin-top: 12px;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input {
      width: 100%;
      padding: 12px;
      background: #232c41;
      border: 2px dashed #be9e6f;
      border-radius: 8px;
      color: #eaf1fa;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-input:hover {
      background: rgba(190, 158, 111, 0.1);
      border-color: #b39264;
    }
    .file-info {
      margin-top: 8px;
      font-size: 14px;
      color: #96b5ff;
    }
    .submit-btn {
      background: linear-gradient(90deg, #be9e6f 70%, #4f46e5 100%);
      color: #fff;
      padding: 15px 35px;
      font-weight: bold;
      font-size: 1.05em;
      border: none;
      border-radius: 12px;
      align-self: flex-end;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .submit-btn:hover {
      background: linear-gradient(90deg, #b39264 0%, #682ae9 90%);
      transform: translateY(-1px);
    }
    .submit-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff33;
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 14px 22px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      z-index: 1000;
      animation: fadeIn 0.4s ease;
      max-width: 350px;
    }
    .alert.success { 
      background: #2ecc71; 
      color: white; 
      border-left: 4px solid #27ae60;
    }
    .alert.error { 
      background: #e74c3c; 
      color: white; 
      border-left: 4px solid #c0392b;
    }
    .alert.info { 
      background: #3498db; 
      color: white; 
      border-left: 4px solid #2980b9;
    }
    .hidden { display: none; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .main-wrapper {
        margin: 20px;
        padding: 20px;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .upload-section {
        grid-column: 1;
      }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="header-row">
      <h1>Project Submission - Review 0</h1>
      <img src="icon.jpg" alt="Profile Icon" class="profile-icon"/>
    </div>

    <nav class="nav-links">
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="projects.html" class="nav-link">View Projects</a>
      <a href="submission-review0.html" class="nav-link active">Submission (Review 0)</a>
    </nav>

    <form id="review0-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="id">Student ID:</label>
          <input type="text" id="id" placeholder="e.g., CS2021001" required/>
        </div>
        <div class="form-group">
          <label for="name">Student Name:</label>
          <input type="text" id="name" placeholder="Enter your full name" required/>
        </div>
        <div class="form-group">
          <label for="class">Class:</label>
          <input type="text" id="class" placeholder="e.g., CSE-A" required/>
        </div>
        <div class="form-group">
          <label for="objective">Project Objective:</label>
          <textarea id="objective" rows="3" placeholder="Describe the main goal of your project..." required></textarea>
        </div>
        <div class="form-group">
          <label for="implementation">Implementation Details:</label>
          <textarea id="implementation" rows="3" placeholder="Explain how you plan to implement the project..." required></textarea>
        </div>
        <div class="form-group">
          <label for="tools">Tools & Technologies:</label>
          <textarea id="tools" rows="2" placeholder="List the tools, languages, and frameworks you'll use..." required></textarea>
        </div>
        <div class="form-group">
          <label for="presentation">Presentation Status:</label>
          <input type="text" id="presentation" placeholder="e.g., Completed, In Progress, Scheduled" required/>
        </div>
        <div class="upload-section">
          <label for="upload">Upload Project Document:</label>
          <div class="file-input-wrapper">
            <input type="file" id="upload" class="file-input" accept=".pdf,.doc,.docx,.txt" required/>
            <div class="file-info" id="file-info">
              üìÑ Choose a file (PDF, DOC, DOCX, TXT - Max 10MB)
            </div>
          </div>
        </div>
      </div>
      <button class="submit-btn" type="submit" id="submit-btn">
        SUBMIT REVIEW 2
      </button>
    </form>
  </div>

  <div id="alert-box" class="alert hidden"></div>

  <script>
    // MongoDB Configuration
    const MONGODB_CONFIG = {
      // Replace with your MongoDB Atlas Data API endpoint
      API_ENDPOINT: 'mongodb+srv://neha:r4p6KvzIL8y01xGd@cluster1.bpcfq4r.mongodb.net/?retryWrites=true&w=majority&appName=Cluster1',
      API_KEY: 'r4p6KvzIL8y01xGd', // Replace with your API key
      DATABASE: 'proassess',
      COLLECTION: 'review2_submissions'
    };

    const form = document.getElementById("review0-form");
    const fileInput = document.getElementById("upload");
    const fileInfo = document.getElementById("file-info");
    const submitBtn = document.getElementById("submit-btn");

    // File input change handler
    fileInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
          showAlert("‚ö†Ô∏è File size must be less than 10MB", "error");
          this.value = '';
          fileInfo.textContent = "üìÑ Choose a file (PDF, DOC, DOCX, TXT - Max 10MB)";
          return;
        }
        fileInfo.innerHTML = `‚úÖ Selected: <strong>${file.name}</strong> (${fileSize} MB)`;
      } else {
        fileInfo.textContent = "üìÑ Choose a file (PDF, DOC, DOCX, TXT - Max 10MB)";
      }
    });

    function showAlert(message, type = "success") {
      const alertBox = document.getElementById("alert-box");
      alertBox.innerHTML = message;
      alertBox.className = `alert ${type}`;
      alertBox.classList.remove("hidden");
      setTimeout(() => alertBox.classList.add("hidden"), 5000);
    }

    // MongoDB API Helper Function
    async function mongoDBRequest(action, data = {}) {
      try {
        const requestBody = {
          collection: MONGODB_CONFIG.COLLECTION,
          database: MONGODB_CONFIG.DATABASE,
          dataSource: 'Cluster1', // Replace with your cluster name
          ...data
        };

        const response = await fetch(`${MONGODB_CONFIG.API_ENDPOINT}/${action}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'api-key': r4p6KvzIL8y01xGd,
            'Access-Control-Request-Headers': '*'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error(`MongoDB API error: ${response.status} ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        console.error('MongoDB API Error:', error);
        throw error;
      }
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Validate form data
    function validateForm(data) {
      const requiredFields = ['studentId', 'studentName', 'studentClass', 'objective', 'implementation', 'tools', 'presentation'];
      
      for (let field of requiredFields) {
        if (!data[field] || data[field].trim() === '') {
          return { valid: false, message: `Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.` };
        }
      }

      if (!data.file) {
        return { valid: false, message: 'Please upload a project document.' };
      }

      // Validate student ID format
      if (!/^[A-Z]{2,3}\d{4}\d{3}$/.test(data.studentId.replace(/[^A-Z0-9]/g, ''))) {
        return { valid: false, message: 'Student ID should be in format like CS2021001.' };
      }

      return { valid: true };
    }

    // Submit form handler
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const studentId = document.getElementById("id").value.trim();
      const studentName = document.getElementById("name").value.trim();
      const studentClass = document.getElementById("class").value.trim();
      const objective = document.getElementById("objective").value.trim();
      const implementation = document.getElementById("implementation").value.trim();
      const tools = document.getElementById("tools").value.trim();
      const presentation = document.getElementById("presentation").value.trim();
      const file = fileInput.files[0];

      // Prepare data for validation
      const formData = {
        studentId,
        studentName,
        studentClass,
        objective,
        implementation,
        tools,
        presentation,
        file
      };

      // Validate form
      const validation = validateForm(formData);
      if (!validation.valid) {
        showAlert(`‚ö†Ô∏è ${validation.message}`, "error");
        return;
      }

      // Disable submit button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div>Submitting...';

      try {
        // Check if MongoDB is configured
        if (!MONGODB_CONFIG.API_KEY || MONGODB_CONFIG.API_KEY === 'r4p6KvzIL8y01xGd') {
          // Demo mode - show success message without actually submitting
          setTimeout(() => {
            showAlert("‚úÖ Demo submission successful! Please configure MongoDB for real submissions.", "info");
            console.log("Demo submission data:", {
              studentId,
              studentName,
              studentClass,
              objective,
              implementation,
              tools,
              presentation,
              fileName: file.name,
              fileSize: file.size
            });
            form.reset();
            fileInfo.textContent = "üìÑ Choose a file (PDF, DOC, DOCX, TXT - Max 10MB)";
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'SUBMIT REVIEW 0';
          }, 1500);
          return;
        }

        // Convert file to base64 for storage
        const fileBase64 = await fileToBase64(file);

        // Check if student already submitted
        const existingSubmission = await mongoDBRequest('findOne', {
          filter: { studentId: studentId }
        });

        if (existingSubmission.document) {
          showAlert("‚ö†Ô∏è You have already submitted Review 0. Contact faculty for updates.", "error");
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'SUBMIT REVIEW 2';
          return;
        }

        // Prepare submission data
        const submissionData = {
          studentId,
          studentName,
          studentClass,
          objective,
          implementation,
          tools,
          presentation,
          fileName: file.name,
          fileSize: file.size,
          fileType: file.type,
          fileData: fileBase64, // Store file as base64
          fileUrl: `review2/${Date.now()}_${file.name}`, // Virtual file path
          submissionType: 'review0',
          status: 'submitted',
          createdAt: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };

        // Insert submission into MongoDB
        const result = await mongoDBRequest('insertOne', {
          document: submissionData
        });

        if (result.insertedId) {
          showAlert("üéâ Project submitted successfully! Your Review 0 has been recorded.", "success");
          
          // Log success for debugging
          console.log("Submission successful:", {
            id: result.insertedId,
            student: studentName,
            timestamp: new Date().toISOString()
          });

          // Reset form
          form.reset();
          fileInfo.textContent = "üìÑ Choose a file (PDF, DOC, DOCX, TXT - Max 10MB)";

          // Optional: Redirect after success
          setTimeout(() => {
            // window.location.href = 'dashboard.html';
          }, 2000);

        } else {
          throw new Error('No insertion ID returned from MongoDB');
        }

      } catch (error) {
        console.error('Submission error:', error);
        
        let errorMessage = "‚ùå Submission failed. Please try again.";
        
        if (error.message.includes('duplicate')) {
          errorMessage = "‚ö†Ô∏è Duplicate submission detected. You may have already submitted this review.";
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
          errorMessage = "üåê Network error. Please check your connection and try again.";
        } else if (error.message.includes('unauthorized') || error.message.includes('api-key')) {
          errorMessage = "üîê Authentication error. Please contact system administrator.";
        }
        
        showAlert(errorMessage, "error");
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'SUBMIT REVIEW 2';
      }
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Show configuration status
      if (!MONGODB_CONFIG.API_KEY || MONGODB_CONFIG.API_KEY === 'r4p6KvzIL8y01xGd') {
        setTimeout(() => {
          showAlert("‚ÑπÔ∏è Running in demo mode. Configure MongoDB for real submissions.", "info");
        }, 1000);
      }

      // Auto-focus first input
      document.getElementById('id').focus();
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        form.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>